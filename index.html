<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro Diario de Cuidados</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        /* Estilos para el switch del turno */
        .toggle-switch-container {
            width: 100%;
            height: 48px;
            background-color: #e2e8f0;
            border-radius: 9999px;
            position: relative;
            padding: 4px;
        }
        .toggle-switch-button {
            height: 100%;
            width: 50%;
            background-color: white;
            border-radius: 9999px;
            transition: transform 0.3s ease;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            position: absolute;
            top: 0;
            bottom: 0;
            margin: auto 0;
            left: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }
        .toggle-switch-container[data-shift="Noche"] .toggle-switch-button {
            transform: translateX(calc(100% - 4px));
        }
        .task-list {
            list-style: none;
            padding: 0;
        }
        .task-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            border-left: 5px solid #3b82f6;
        }
        .task-text {
            flex-grow: 1;
        }
        .task-checkbox-label {
            display: block;
            position: relative;
            padding-left: 35px;
            cursor: pointer;
            user-select: none;
        }
        .task-checkbox-label input {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }
        .checkmark {
            position: absolute;
            top: 0;
            left: 0;
            height: 25px;
            width: 25px;
            background-color: #eee;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .task-checkbox-label input:checked ~ .checkmark {
            background-color: #10b981;
        }
        .checkmark:after {
            content: "";
            position: absolute;
            display: none;
        }
        .task-checkbox-label input:checked ~ .checkmark:after {
            display: block;
        }
        .task-checkbox-label .checkmark:after {
            left: 9px;
            top: 5px;
            width: 5px;
            height: 10px;
            border: solid white;
            border-width: 0 3px 3px 0;
            transform: rotate(45deg);
        }
        .time-stamp {
            font-size: 0.75rem;
            color: #6b7280;
            margin-left: 1rem;
            font-weight: 500;
        }
        .observation-box {
            margin-top: 1rem;
            background-color: #f0f9ff;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px dashed #93c5fd;
        }
        .disabled-input {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="loading-spinner" class="fixed inset-0 bg-white bg-opacity-80 flex justify-center items-center z-50">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
    </div>

    <div id="app-container" class="max-w-xl mx-auto bg-white p-6 rounded-xl shadow-2xl transition-all duration-300 hidden">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-2">Registro de Cuidados</h1>
        <p class="text-sm text-gray-500 mb-6">Completa las actividades de tu turno. Tu ID: <span id="user-id-display" class="font-mono text-xs bg-gray-100 p-1 rounded">Cargando...</span></p>

        <!-- Selección de Cuidador -->
        <div class="mb-5 p-4 bg-blue-50 rounded-lg">
            <label for="caretaker-select" class="block text-lg font-medium text-gray-700 mb-2">1. Cuidador Asignado</label>
            <select id="caretaker-select" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-base">
            </select>
        </div>

        <!-- Selección de Turno -->
        <div class="mb-5 p-4 bg-gray-50 rounded-lg">
            <label class="block text-lg font-medium text-gray-700 mb-2">2. Turno</label>
            <div id="shift-toggle" class="toggle-switch-container cursor-pointer" data-shift="Día">
                <span class="toggle-switch-button" id="toggle-indicator">Día</span>
                <div class="absolute inset-0 flex items-center justify-between text-gray-600 font-semibold px-4">
                    <span class="w-1/2 text-center text-blue-700" data-shift-name="Día">Turno de Día</span>
                    <span class="w-1/2 text-center" data-shift-name="Noche">Turno de Noche</span>
                </div>
            </div>
        </div>

        <!-- Selección de Paciente -->
        <div class="mb-6 p-4 bg-blue-50 rounded-lg">
            <label for="patient-select" class="block text-lg font-medium text-gray-700 mb-2">3. Paciente</label>
            <select id="patient-select" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-base">
            </select>
        </div>

        <!-- Sección de Tareas y Reporte -->
        <div id="tasks-section" class="border-t pt-6 hidden">
            <h2 id="patient-complication" class="text-xl font-bold text-red-600 mb-4 bg-red-100 p-3 rounded-lg"></h2>

            <h3 class="text-2xl font-semibold text-gray-800 mb-4">Obligaciones del Turno (<span id="current-shift-display">Día</span>)</h3>
            <ul id="task-list" class="task-list">
                <!-- Tasks will be injected here -->
            </ul>

            <!-- Observaciones Finales -->
            <div class="observation-box mt-8">
                <h4 class="font-bold text-gray-700 mb-2">Observaciones Generales del Turno</h4>
                <textarea id="general-observations" rows="4" class="w-full p-3 border rounded-lg resize-none focus:ring-blue-500 focus:border-blue-500" placeholder="Escribe aquí cualquier nota importante, incidencias o comentarios finales..."></textarea>
            </div>

            <!-- Botón de Reporte -->
            <button id="send-report-btn" class="w-full mt-6 py-4 bg-green-600 hover:bg-green-700 text-white font-bold text-lg rounded-xl shadow-lg transition duration-150 ease-in-out transform hover:scale-[1.01] disabled:bg-gray-400" disabled>
                <span id="report-text">Selecciona Cuidador y Paciente</span>
            </button>
            <p id="report-status" class="text-center text-sm mt-2 text-gray-500"></p>

            <!-- Modal de estado/error -->
            <div id="status-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4">
                <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full">
                    <h3 id="modal-title" class="text-xl font-bold mb-3 text-gray-800"></h3>
                    <p id="modal-message" class="text-gray-600 mb-4"></p>
                    <button onclick="document.getElementById('status-modal').classList.add('hidden');" class="w-full py-2 bg-blue-500 text-white rounded-lg">Cerrar</button>
                </div>
            </div>

        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc, collection, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Establecer el nivel de log para depuración de Firestore
        setLogLevel('debug');

        // --- Variables Globales de Canvas (MANDATORIAS) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { /* Añade config de prueba si es necesario */ };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        // --------------------------------------------------

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let userId = null;
        let authReady = false;

        const ui = {
            loadingSpinner: document.getElementById('loading-spinner'),
            appContainer: document.getElementById('app-container'),
            userIdDisplay: document.getElementById('user-id-display'),
            caretakerSelect: document.getElementById('caretaker-select'),
            patientSelect: document.getElementById('patient-select'),
            shiftToggle: document.getElementById('shift-toggle'),
            currentShiftDisplay: document.getElementById('current-shift-display'),
            tasksSection: document.getElementById('tasks-section'),
            taskList: document.getElementById('task-list'),
            patientComplication: document.getElementById('patient-complication'),
            generalObservations: document.getElementById('general-observations'),
            sendReportBtn: document.getElementById('send-report-btn'),
            reportText: document.getElementById('report-text'),
            reportStatus: document.getElementById('report-status'),
            statusModal: document.getElementById('status-modal'),
            modalTitle: document.getElementById('modal-title'),
            modalMessage: document: document.getElementById('modal-message')
        };

        // --- Modelos de Datos ---
        const CAREGIVERS = [
            "Ana García", "Beto López", "Carla Ruiz", "David Soto", "Elena Vega"
        ];

        const PATIENT_DATA = {
            "Don Ricardo": {
                complication: "Alzheimer Avanzado y Hipertensión Crónica.",
                meds: "Losartan, Memantine.",
                day_tasks: [
                    { id: "p1_d1", text: "Toma de Presión Arterial (9:00 AM)" },
                    { id: "p1_d2", text: "Administrar Losartan y Memantine (9:30 AM)" },
                    { id: "p1_d3", text: "Paseo de 1 hora o actividad de estimulación (11:00 AM)" },
                    { id: "p1_d4", text: "Toma de Presión Arterial (3:00 PM)" }
                ],
                night_tasks: [
                    { id: "p1_n1", text: "Administrar Memantine nocturna (9:00 PM)" },
                    { id: "p1_n2", text: "Observación especial: Propenso a la agitación nocturna. Asegurar que la luz suave esté encendida." },
                    { id: "p1_n3", text: "Verificar cierres de seguridad y puertas (10:00 PM)" },
                    { id: "p1_n4", text: "Revisar estado de pañal antes de dormir." }
                ]
            },
            "Doña Sofía": {
                complication: "Diabetes Tipo 2 e Insuficiencia Renal Crónica.",
                meds: "Metformin, Insulina.",
                day_tasks: [
                    { id: "p2_d1", text: "Control de Glucosa en Sangre (8:00 AM) y registro." },
                    { id: "p2_d2", text: "Administrar Metformin e Insulina (8:30 AM - con desayuno)" },
                    { id: "p2_d3", text: "Monitorizar y registrar ingesta de líquidos (ml) - Importante para el riñón." },
                    { id: "p2_d4", text: "Control de Glucosa y Administrar Insulina (1:30 PM - con almuerzo)" }
                ],
                night_tasks: [
                    { id: "p2_n1", text: "Control de Glucosa y Administrar Insulina (8:00 PM - con cena)" },
                    { id: "p2_n2", text: "Observación especial: Requiere visitas frecuentes al baño. Colocar pañal absorbente en cama." },
                    { id: "p2_n3", text: "Registro de frecuencia urinaria nocturna." },
                    { id: "p2_n4", text: "Revisión de piel en puntos de presión (talones, sacro)." }
                ]
            },
            "Niño Hugo": {
                complication: "Asma Severa y Trastorno del Espectro Autista (Nivel 3).",
                meds: "Salbutamol Inhalado (PRN), Esteroides Orales.",
                day_tasks: [
                    { id: "p3_d1", text: "Monitoreo de flujo máximo (Peak Flow) - Registrar valor." },
                    { id: "p3_d2", text: "Sesión de fisioterapia respiratoria/juego sensorial (10:00 AM)" },
                    { id: "p3_d3", text: "Preparar y servir comida de dieta especial (evitar lácteos y gluten)." },
                    { id: "p3_d4", text: "Administrar Salbutamol si es necesario (PRN) - Registrar dosis y hora." }
                ],
                night_tasks: [
                    { id: "p3_n1", text: "Administrar Esteroides Orales (7:00 PM)" },
                    { id: "p3_n2", text: "Observación especial: Enuresis (orinación de cama) y alta sensibilidad a la temperatura. Asegurar temperatura ambiente estable (22°C)." },
                    { id: "p3_n3", text: "Despertar y cambiar pañal/ropa de cama a la 1:00 AM (obligatorio si hace frío o si está mojado)." },
                    { id: "p3_n4", text: "Verificar humidificador funcionando correctamente." }
                ]
            }
        };

        // --- Estado Local de la Aplicación ---
        let currentReportId = null;
        let currentReport = {}; // Almacenará el estado del reporte de Firestore

        const state = {
            caretaker: null,
            patient: null,
            shift: 'Día', // 'Día' o 'Noche'
        };

        // --- Funciones de Utilidad ---
        function getTodayDateString() {
            const date = new Date();
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }

        function getCurrentReportKey() {
            const date = getTodayDateString();
            return state.patient && state.shift ? `${date}_${state.patient.replace(/\s/g, '')}_${state.shift}` : null;
        }

        function showModal(title, message) {
            ui.modalTitle.textContent = title;
            ui.modalMessage.textContent = message;
            ui.statusModal.classList.remove('hidden');
            ui.statusModal.classList.add('flex');
        }

        // --- Lógica de Base de Datos (Firestore) ---
        async function updateFirestoreReport(taskId, observationId, type, value) {
            if (!authReady || !userId || !currentReportId) {
                console.error("Firestore no está listo o no hay un ID de reporte.");
                return;
            }

            const reportRef = doc(db, `artifacts/${appId}/public/data/daily_reports`, currentReportId);

            try {
                const now = new Date().toISOString();
                let updateData = {};

                if (type === 'checklist') {
                    // Si es un checklist, el valor es el timestamp actual
                    const taskPath = `tasks.${taskId}.completedAt`;
                    updateData[taskPath] = now;
                    // Actualizar el estado local inmediatamente para evitar parpadeos
                    currentReport.tasks = currentReport.tasks || {};
                    currentReport.tasks[taskId] = currentReport.tasks[taskId] || {};
                    currentReport.tasks[taskId].completedAt = now;
                } else if (type === 'observation') {
                    const obsPath = `observations.${observationId}`;
                    updateData[obsPath] = value;
                    // Actualizar el estado local
                    currentReport.observations = currentReport.observations || {};
                    currentReport.observations[observationId] = value;
                } else if (type === 'generalObservation') {
                    updateData.generalObservation = value;
                    currentReport.generalObservation = value;
                } else if (type === 'initialSetup') {
                    // Primera vez, establecemos la estructura base
                    updateData = {
                        caretaker: state.caretaker,
                        patient: state.patient,
                        shift: state.shift,
                        date: getTodayDateString(),
                        tasks: {},
                        observations: {},
                        generalObservation: value,
                        caretaker_uid: userId // Para propósitos de seguimiento
                    };
                    currentReport = updateData;
                }

                await setDoc(reportRef, updateData, { merge: true });
                console.log("Reporte de Firestore actualizado con éxito.");

            } catch (error) {
                console.error("Error al actualizar Firestore:", error);
                showModal("Error de Base de Datos", "No se pudo guardar el dato. Revisa la conexión o contacta al administrador.");
            }
        }

        function listenToReportChanges() {
            if (!authReady || !userId) return;

            const reportKey = getCurrentReportKey();
            if (!reportKey) return;

            currentReportId = reportKey;
            ui.sendReportBtn.disabled = false;
            ui.reportText.textContent = "Enviar Reporte (Vía WhatsApp)";

            const reportRef = doc(db, `artifacts/${appId}/public/data/daily_reports`, reportKey);

            // Intentar cargar la estructura inicial si no existe
            const unsubscribe = onSnapshot(reportRef, async (docSnap) => {
                if (docSnap.exists()) {
                    currentReport = docSnap.data();
                    console.log("Datos de Firestore cargados/actualizados:", currentReport);
                } else {
                    console.log("Reporte no existe. Creando estructura inicial.");
                    // Inicializar el reporte en Firestore con la estructura mínima
                    await updateFirestoreReport(null, null, 'initialSetup', '');
                }
                renderTasks();
            }, (error) => {
                console.error("Error al escuchar cambios en Firestore:", error);
                showModal("Error de Conexión", "No se pudo sincronizar el reporte en tiempo real.");
            });

            // Retornar la función de desuscripción
            return unsubscribe;
        }

        // --- Lógica de Renderizado y UI ---
        function populateSelectors() {
            // Cuidadores
            CAREGIVERS.forEach(c => {
                const option = document.createElement('option');
                option.value = c;
                option.textContent = c;
                ui.caretakerSelect.appendChild(option);
            });
            // Pacientes
            Object.keys(PATIENT_DATA).forEach(p => {
                const option = document.createElement('option');
                option.value = p;
                option.textContent = p;
                ui.patientSelect.appendChild(option);
            });
        }

        function updateShiftVisual() {
            const isDay = state.shift === 'Día';
            ui.shiftToggle.dataset.shift = state.shift;
            ui.toggleIndicator.textContent = state.shift;
            
            const dayText = ui.shiftToggle.querySelector('[data-shift-name="Día"]');
            const nightText = ui.shiftToggle.querySelector('[data-shift-name="Noche"]');

            dayText.classList.toggle('text-blue-700', isDay);
            dayText.classList.toggle('text-gray-600', !isDay);
            nightText.classList.toggle('text-blue-700', !isDay);
            nightText.classList.toggle('text-gray-600', isDay);

            ui.currentShiftDisplay.textContent = state.shift;
        }

        function renderTasks() {
            if (!state.patient) {
                ui.tasksSection.classList.add('hidden');
                return;
            }

            ui.tasksSection.classList.remove('hidden');
            ui.taskList.innerHTML = '';
            ui.patientComplication.textContent = `Atención: ${PATIENT_DATA[state.patient].complication}`;

            const taskKey = state.shift === 'Día' ? 'day_tasks' : 'night_tasks';
            const tasks = PATIENT_DATA[state.patient][taskKey];
            let listHTML = '';

            tasks.forEach((task, index) => {
                const taskId = task.id;
                const obsId = `obs_${taskId}`;
                const taskStatus = currentReport.tasks?.[taskId] || {};
                const isChecked = !!taskStatus.completedAt;
                const observationText = currentReport.observations?.[obsId] || '';
                const timeStamp = taskStatus.completedAt ? new Date(taskStatus.completedAt).toLocaleString('es-MX', { dateStyle: 'short', timeStyle: 'short' }) : 'Pendiente';

                listHTML += `
                    <li class="task-item flex flex-col md:flex-row items-start md:items-center">
                        <div class="flex items-center w-full md:w-3/4 mb-2 md:mb-0">
                            <span class="text-base text-gray-700 font-medium task-text">${task.text}</span>
                        </div>
                        <div class="flex items-center justify-end w-full md:w-1/4">
                            <span class="time-stamp mr-3">${timeStamp}</span>
                            <label class="task-checkbox-label">
                                <input type="checkbox" data-task-id="${taskId}" onchange="handleTaskCheck(this)" ${isChecked ? 'checked disabled' : ''}>
                                <span class="checkmark"></span>
                            </label>
                        </div>
                    </li>
                    <div class="observation-box mb-4">
                        <h4 class="font-semibold text-xs text-gray-600 mb-1">Observaciones de la Actividad:</h4>
                        <textarea id="${obsId}" data-obs-id="${obsId}" rows="1" class="w-full p-2 border rounded-lg text-sm resize-none focus:ring-blue-500 focus:border-blue-500"
                            placeholder="Añadir nota (ej: Presión 120/80, Glucosa 140 mg/dL, sin incidentes).">${observationText}</textarea>
                    </div>
                `;
            });
            ui.taskList.innerHTML = listHTML;
            
            // Renderizar la observación general
            ui.generalObservations.value = currentReport.generalObservation || '';
            ui.generalObservations.oninput = (e) => updateFirestoreReport(null, null, 'generalObservation', e.target.value);


            // Re-adjuntar listeners para las observaciones de tareas
            tasks.forEach(task => {
                const obsId = `obs_${task.id}`;
                const textarea = document.getElementById(obsId);
                if (textarea) {
                    // Prevenir guardar en cada pulsación, usar debounce o blur
                    textarea.onchange = (e) => updateFirestoreReport(null, obsId, 'observation', e.target.value);
                }
            });
        }

        // --- Manejadores de Eventos Globales ---
        window.handleTaskCheck = (checkbox) => {
            const taskId = checkbox.dataset.taskId;
            if (checkbox.checked) {
                // Registrar el check en Firestore
                updateFirestoreReport(taskId, null, 'checklist', true);
                // La función de escucha de Firestore (onSnapshot) se encargará de re-renderizar
                // con el timestamp y el estado de deshabilitado.
            }
        }
        
        // Función principal para manejar los cambios de estado (Cuidador/Paciente/Turno)
        function handleStateChange() {
            // 1. Actualizar el estado local
            state.caretaker = ui.caretakerSelect.value;
            state.patient = ui.patientSelect.value;
            // state.shift se actualiza con el toggle

            // 2. Desuscribirse del reporte anterior (si existe)
            if (window.unsubscribeReport) {
                window.unsubscribeReport();
                currentReport = {}; // Limpiar el estado local del reporte
            }
            
            // 3. Renderizar o habilitar el botón de reporte
            if (state.caretaker && state.patient) {
                // 4. Iniciar la escucha del nuevo reporte (o crearlo)
                window.unsubscribeReport = listenToReportChanges();
                ui.tasksSection.classList.remove('hidden');
                ui.sendReportBtn.disabled = false;
                ui.reportText.textContent = "Enviar Reporte (Vía WhatsApp)";
            } else {
                ui.tasksSection.classList.add('hidden');
                ui.sendReportBtn.disabled = true;
                ui.reportText.textContent = "Selecciona Cuidador y Paciente";
            }
        }

        // --- Generación del Reporte (WhatsApp) ---
        ui.sendReportBtn.addEventListener('click', () => {
            if (!currentReport || !state.patient) {
                showModal("Error", "Debes seleccionar un paciente y cuidador primero.");
                return;
            }

            const tasks = PATIENT_DATA[state.patient][state.shift === 'Día' ? 'day_tasks' : 'night_tasks'];
            let reportMessage = `*REPORTE DE CUIDADOS DIARIO*\n\n`;
            reportMessage += `*Fecha:* ${currentReport.date}\n`;
            reportMessage += `*Turno:* ${currentReport.shift}\n`;
            reportMessage += `*Paciente:* ${currentReport.patient}\n`;
            reportMessage += `*Cuidador:* ${currentReport.caretaker}\n`;
            reportMessage += `*Complicación:* ${PATIENT_DATA[state.patient].complication}\n\n`;
            reportMessage += `------------------------------------\n`;
            reportMessage += `*ACTIVIDADES Y MEDICAMENTOS*\n`;
            reportMessage += `------------------------------------\n`;

            let pendingCount = 0;
            tasks.forEach(task => {
                const status = currentReport.tasks?.[task.id]?.completedAt ? '✅' : '❌';
                const time = currentReport.tasks?.[task.id]?.completedAt ? new Date(currentReport.tasks[task.id].completedAt).toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' }) : 'PENDIENTE';
                const obsId = `obs_${task.id}`;
                const observation = currentReport.observations?.[obsId] || 'Sin observaciones.';

                reportMessage += `\n${status} *${task.text}*\n`;
                reportMessage += `  - _Hora de Registro:_ ${time}\n`;
                reportMessage += `  - _Observación:_ ${observation}\n`;

                if (status === '❌') pendingCount++;
            });

            reportMessage += `\n------------------------------------\n`;
            reportMessage += `*OBSERVACIONES GENERALES DEL TURNO*\n`;
            reportMessage += `------------------------------------\n`;
            reportMessage += currentReport.generalObservation || 'Ninguna observación general registrada.';
            
            reportMessage += `\n\n*RESUMEN:* ${pendingCount === 0 ? 'Todas las tareas completadas.' : `⚠️ ${pendingCount} tarea(s) pendiente(s).`}`;


            // Codificar el mensaje para la URL de WhatsApp
            const encodedMessage = encodeURIComponent(reportMessage);
            const whatsappUrl = `https://wa.me/524451586270?text=${encodedMessage}`;

            // Abrir la ventana de WhatsApp
            window.open(whatsappUrl, '_blank');
            ui.reportStatus.textContent = "Reporte enviado a WhatsApp. (Asegúrate de confirmar el envío en la ventana emergente)";
        });

        // --- Inicialización y Autenticación ---
        async function initializeApp() {
            try {
                // 1. Autenticación (con token personalizado si existe, anónima si no)
                await setPersistence(auth, browserSessionPersistence);
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Error durante la autenticación de Firebase:", error);
                showModal("Error de Autenticación", "No se pudo iniciar sesión. La aplicación no podrá guardar datos.");
            }

            // 2. Listener de estado de autenticación (Para obtener el userId)
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    authReady = true;
                    ui.userIdDisplay.textContent = user.uid;
                    console.log("Usuario autenticado. UID:", userId);
                    
                    // 3. Poblar selectores y configurar listeners
                    populateSelectors();
                    // Seleccionar un valor por defecto para disparar la carga inicial
                    ui.caretakerSelect.value = CAREGIVERS[0];
                    ui.patientSelect.value = Object.keys(PATIENT_DATA)[0];
                    handleStateChange(); // Carga inicial

                    // 4. Configurar listeners de cambio de selectores
                    ui.caretakerSelect.addEventListener('change', handleStateChange);
                    ui.patientSelect.addEventListener('change', handleStateChange);

                    // 5. Configurar listener de cambio de turno (Toggle)
                    ui.shiftToggle.addEventListener('click', () => {
                        state.shift = state.shift === 'Día' ? 'Noche' : 'Día';
                        updateShiftVisual();
                        handleStateChange(); // Re-renderizar tareas y cambiar reporte
                    });

                    // Ocultar spinner y mostrar la app
                    ui.loadingSpinner.classList.add('hidden');
                    ui.appContainer.classList.remove('hidden');

                } else {
                    console.log("No hay usuario autenticado.");
                    // Si la autenticación falla, dejar el authReady en false.
                }
            });
        }

        // Iniciar la aplicación
        initializeApp();
    </script>
</body>
</html>

