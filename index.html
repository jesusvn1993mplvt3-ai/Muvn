<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MUVN - Acceso de Doble Factor</title>
    
    <!-- Metadatos -->
    <meta property="og:title" content="MUVN - Equipo de Cuidados">
    <meta property="og:image" content="https://raw.githubusercontent.com/jesusvn1993mplvt3-ai/proyecto_cuidadores_MUVN/refs/heads/main/MUVN.jpg">

    <style>
        @keyframes scan {
            0% { top: 0%; opacity: 0; }
            50% { opacity: 1; box-shadow: 0 0 20px rgba(34, 211, 238, 0.8); } /* Cyan */
            100% { top: 100%; opacity: 0; }
        }
        .scanner-line {
            position: absolute;
            left: 0;
            width: 100%;
            height: 3px;
            background: #22d3ee; /* Cyan */
            animation: scan 1.5s linear infinite;
            z-index: 20;
        }
        .camera-overlay { background: rgba(15, 23, 42, 0.95); }
        .glass-panel { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
    </style>
</head>
<body class="bg-slate-900 text-gray-100 font-sans pb-24 selection:bg-cyan-500 selection:text-white">

    <div id="root"></div>

    <script type="text/babel">

        // --- ICONOS ---
        const Icons = {
            Sun: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>,
            Moon: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>,
            User: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            CheckCircle: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
            Clock: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            Send: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>,
            Trash2: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
            Activity: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>,
            AlertCircle: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>,
            ClipboardList: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></svg>,
            Lock: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
            Edit: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>,
            Camera: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>,
            X: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
            Brain: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></svg>,
            ShieldCheck: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="m9 12 2 2 4-4"/></svg>,
            ShieldAlert: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>,
            Calendar: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
            Paw: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="4" r="2"/><circle cx="18" cy="8" r="2"/><circle cx="6" cy="10" r="2"/><path d="M10 20.2c.4-.4.8-1 1.2-1.7s.9-1.3 1.5-1.9c.7-.5 1.7-1 3.3-1.4 1.7-.4 3.6-1 5.3-2.1"/><path d="M16 16s-1.5-1-2-1.5c-.7-.7-1.4-1.2-1.8-1.5s-.8-1-1.3-1.8c-.8-1.2-1-2.4-1.1-2.9"/><path d="M15 21s-2-1.5-2.5-2c-.5-.5-1-1.2-1-1.8s-.5-1-1-1.5c-.8-1.3-1-2.5-1.1-3.2"/></svg>
        };

        // --- DATA DE CUIDADORES Y PACIENTES (SEGURO) ---
        // Ahora cada cuidador tiene asignado:
        // 1. Un paciente √∫nico (patientId)
        // 2. Un DOB (Date of Birth) como factor de seguridad
        // 3. Un Pet Name (Mascota) como factor de seguridad
        const CAREGIVER_DATA = [
            { name: "Ana Mart√≠nez", patientId: "p1", dob: "1990-05-15", pet: "Luna" },
            { name: "Carlos Vel√°zquez", patientId: "p2", dob: "1985-11-20", pet: "Rocky" },
            { name: "Beatriz Sol√≠s", patientId: "p3", dob: "2000-01-01", pet: "Toby" },
            { name: "David L√≥pez", patientId: "p4", dob: "1978-08-25", pet: "Milo" },
            { name: "Elena Ram√≠rez", patientId: "p5", dob: "1995-03-10", pet: "Mia" }
        ];

        const PATIENTS = [
            { id: 'p1', name: "Don Roberto", details: "Diabetes/Hipertensi√≥n", tasks: { dia: [{ id: 't1_d1', text: "Toma de Glucosa", type: "vital" }, { id: 't1_d2', text: "Insulina NPH 15uds", type: "med" }, { id: 't1_d5', text: "Metformina 850mg", type: "med" }], noche: [{ id: 't1_n1', text: "Cena ligera", type: "food" }, { id: 't1_n2', text: "Revisi√≥n pa√±al", type: "check" }, { id: 't1_n3', text: "Insulina Nocturna", type: "med" }] } },
            { id: 'p2', name: "Do√±a Mar√≠a", details: "Alzheimer", tasks: { dia: [{ id: 'p2_d1', text: "Memantina 10mg", type: "med" }, { id: 'p2_d3', text: "Ejercicios cognitivos", type: "activity" }], noche: [{ id: 'p2_n1', text: "Quetiapina", type: "med" }, { id: 'p2_n2', text: "Subir barandales", type: "safety" }, { id: 'p2_n4', text: "Cambio pa√±al (Nota: Siempre verificar incontinencia)", type: "hygiene" }] } },
            { id: 'p3', name: "Sr. Pedro", details: "Post-Op Cadera (Detalles sensibles)", tasks: { dia: [{ id: 'p3_d1', text: "Curaci√≥n herida", type: "nursing" }, { id: 'p3_d4', text: "Cambio postura (3h)", type: "check" }], noche: [{ id: 'p3_n1', text: "Analg√©sico", type: "med" }, { id: 'p3_n2', text: "Postura Izquierda (Nota: No presionar cicatriz)", type: "check" }, { id: 'p3_n3', text: "Postura Arriba", type: "check" }] } },
            { id: 'p4', name: "Sra. Carmen", details: "Parkinson", tasks: { dia: [{ id: 'p4_d1', text: "Levodopa (30min antes)", type: "med" }, { id: 'p4_d2', text: "Ayuda comida", type: "food" }], noche: [{ id: 'p4_n1', text: "Meds Nocturnos", type: "med" }, { id: 'p4_n3', text: "Almohadas", type: "check" }] } },
            { id: 'p5', name: "Don Luis", details: "EPOC / Ox√≠geno", tasks: { dia: [{ id: 'p5_d1', text: "Nebulizaci√≥n", type: "nursing" }, { id: 'p5_d2', text: "Revisar O2", type: "env" }], noche: [{ id: 'p5_n1', text: "Conectar CPAP", type: "nursing" }, { id: 'p5_n2', text: "Oximetr√≠a", type: "vital" }] } },
        ];


        // --- COMPONENTE DE SEGURIDAD BIOM√âTRICA (CEREBRO) ---
        // Simplificado para solo detectar y auto-aprobar
        const BiometricScanner = ({ onAuthSuccess, onCancel, userName }) => {
            const videoRef = React.useRef(null);
            const canvasRef = React.useRef(null);
            
            const [status, setStatus] = React.useState("Cargando Modelos Neuronales...");
            const [isReady, setIsReady] = React.useState(false);
            const [matchResult, setMatchResult] = React.useState(null); 

            React.useEffect(() => {
                loadModels();
            }, []);

            const loadModels = async () => {
                const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/';
                try {
                    await Promise.all([
                        faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                        faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                        faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                    ]);
                    setStatus("Iniciando √ìptica...");
                    startCamera();
                } catch (err) {
                    setStatus("Error en Sistema IA");
                }
            };

            const startCamera = async () => {
                try {
                    // Pedir la c√°mara frontal
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: {
                            facingMode: "user"
                        } 
                    });
                    if (videoRef.current) videoRef.current.srcObject = stream;
                } catch (err) {
                    setStatus("C√°mara bloqueada o no disponible.");
                }
            };

            const handleVideoPlay = () => {
                setStatus("BUSCANDO ROSTRO...");
                setIsReady(true);
                
                // Intervalo de escaneo
                const interval = setInterval(async () => {
                    if (!videoRef.current || !canvasRef.current) return;

                    // 1. Detectar cara y calcular descriptor (vector num√©rico √∫nico de la cara)
                    const detection = await faceapi.detectSingleFace(
                        videoRef.current, 
                        new faceapi.TinyFaceDetectorOptions()
                    ).withFaceLandmarks().withFaceDescriptor();

                    if (detection) {
                        const dims = faceapi.matchDimensions(canvasRef.current, videoRef.current);
                        const resized = faceapi.resizeResults(detection, dims);
                        
                        // Dibujar cuadro para indicar detecci√≥n
                        faceapi.draw.drawDetections(canvasRef.current, resized);

                        // Auto-aprobar una vez detectado un rostro (Modo de Seguridad Suave)
                        setMatchResult('match');
                        setStatus("ROSTRO DETECTADO. Capturando...");
                        clearInterval(interval);
                        captureAndClose(detection.descriptor);
                        
                    } else {
                        setStatus("Aseg√∫rate de que tu rostro est√© en el centro.");
                        setMatchResult(null);
                        const ctx = canvasRef.current.getContext('2d');
                        ctx.clearRect(0,0, canvasRef.current.width, canvasRef.current.height);
                    }
                }, 500); // Revisar cada 500ms
                
                return () => clearInterval(interval);
            };

            const captureAndClose = (descriptor) => {
                // Capturar foto visual
                const canvas = document.createElement('canvas');
                canvas.width = videoRef.current.videoWidth;
                canvas.height = videoRef.current.videoHeight;
                canvas.getContext('2d').drawImage(videoRef.current, 0, 0);
                const photoData = canvas.toDataURL('image/jpeg', 0.8);
                
                // Detener c√°mara
                const stream = videoRef.current.srcObject;
                stream.getTracks().forEach(t => t.stop());

                // Retornar datos (Foto + Vector Biom√©trico)
                onAuthSuccess(photoData, descriptor);
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 camera-overlay backdrop-blur-sm">
                    <div className="bg-slate-900 border-2 border-slate-700 rounded-2xl overflow-hidden w-full max-w-md shadow-2xl relative">
                        
                        {/* HEADER */}
                        <div className="p-4 bg-slate-800 flex justify-between items-center border-b border-slate-700">
                            <div className="flex items-center gap-2 text-cyan-400">
                                <Icons.Brain />
                                <span className="font-mono font-bold tracking-wider">MUVN SECURITY</span>
                            </div>
                            <button onClick={onCancel} className="text-slate-400 hover:text-white"><Icons.X /></button>
                        </div>
                        
                        {/* VISOR */}
                        <div className="relative bg-black aspect-[3/4] flex items-center justify-center overflow-hidden group">
                            <video 
                                ref={videoRef} 
                                autoPlay 
                                muted 
                                playsInline 
                                onPlay={handleVideoPlay}
                                className="w-full h-full object-cover scale-x-[-1] opacity-80"
                            />
                            <canvas ref={canvasRef} className="absolute inset-0 w-full h-full scale-x-[-1]" />
                            
                            {/* ESCANER VISUAL */}
                            <div className="scanner-line"></div>
                            
                            {/* MENSAJES DE ESTADO (HUD) */}
                            <div className="absolute top-4 left-4 right-4 text-center">
                                <span className={`inline-block px-3 py-1 rounded font-mono text-xs font-bold backdrop-blur-md border ${
                                    matchResult === 'match' ? 'bg-green-500/20 border-green-500 text-green-400' : 
                                    'bg-cyan-500/20 border-cyan-500 text-cyan-400'
                                }`}>
                                    {matchResult === 'match' ? 'ROSTRO ENCONTRADO' : status}
                                </span>
                            </div>
                        </div>

                        {/* BOTONES */}
                        <div className="p-6 bg-slate-800">
                            <div className={`text-center font-bold text-lg text-slate-400`}>
                                {matchResult === 'match' ? "CONTINUANDO AL 2¬∫ FACTOR..." : "ESPERANDO DETECCI√ìN BIOM√âTRICA..."}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- COMPONENTE DE AUTENTICACI√ìN SECRETA (2¬∫ FACTOR) ---
        const SecretAuth = ({ caregiverName, requiredDob, requiredPet, onSuccess }) => {
            const [dob, setDob] = React.useState('');
            const [pet, setPet] = React.useState('');
            const [error, setError] = React.useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                setError('');

                // Limpiar y normalizar entradas
                const cleanDob = dob.trim();
                const cleanPet = pet.trim().toLowerCase();
                const cleanRequiredPet = requiredPet.toLowerCase();

                if (cleanDob === requiredDob && cleanPet === cleanRequiredPet) {
                    onSuccess();
                } else {
                    setError('ERROR DE AUTENTICACI√ìN. Verifica Fecha y Mascota.');
                }
            };

            return (
                <div className="glass-panel p-6 rounded-xl shadow-lg space-y-4 border-2 border-amber-500/50">
                    <h2 className="text-xl font-bold text-amber-300 flex items-center gap-2">
                        <Icons.Lock /> Verificaci√≥n de Acceso Seguro (Paso 2)
                    </h2>
                    <p className="text-sm text-slate-400">
                        {caregiverName}, confirma tu identidad para acceder a la ficha de tu paciente.
                    </p>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div>
                            <label className="block text-sm font-medium text-slate-300 mb-1 flex items-center gap-2">
                                <Icons.Calendar /> Fecha de Nacimiento (YYYY-MM-DD)
                            </label>
                            <input
                                type="date"
                                value={dob}
                                onChange={(e) => setDob(e.target.value)}
                                className="w-full p-3 bg-slate-800 border border-slate-600 rounded-lg text-lg text-white outline-none focus:border-amber-500 transition-colors"
                                required
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-slate-300 mb-1 flex items-center gap-2">
                                <Icons.Paw /> Nombre de tu Mascota
                            </label>
                            <input
                                type="text"
                                value={pet}
                                onChange={(e) => setPet(e.target.value)}
                                className="w-full p-3 bg-slate-800 border border-slate-600 rounded-lg text-lg text-white outline-none focus:border-amber-500 transition-colors"
                                placeholder="Ej: Luna, Rocky, Toby"
                                required
                            />
                        </div>
                        <button type="submit" className="w-full py-3 rounded font-bold flex items-center justify-center gap-2 transition-all bg-amber-600 hover:bg-amber-500 text-white shadow-md shadow-amber-900/50">
                            <Icons.ShieldCheck /> Confirmar Identidad
                        </button>
                    </form>
                    {error && (
                        <p className="text-sm text-center text-red-400 bg-red-900/30 p-2 rounded flex items-center justify-center gap-2">
                            <Icons.AlertCircle /> {error}
                        </p>
                    )}
                </div>
            );
        };


        function App() {
            // --- ESTADOS ---
            const [caregiverData, setCaregiverData] = React.useState(null); // Objeto completo del cuidador logueado
            const [caregiverPhoto, setCaregiverPhoto] = React.useState(null); 
            const [showScanner, setShowScanner] = React.useState(false); 
            const [tempCaregiverName, setTempCaregiverName] = React.useState(""); 
            const [isSecretAuthenticated, setIsSecretAuthenticated] = React.useState(false); // Nuevo estado para el 2¬∫ factor

            const [shift, setShift] = React.useState("");
            const [records, setRecords] = React.useState({});

            // --- CARGAR DATOS ---
            React.useEffect(() => {
                const savedApp = localStorage.getItem('careApp_data_v7');
                if (savedApp) {
                    const parsed = JSON.parse(savedApp);
                    setCaregiverData(parsed.caregiverData || null);
                    setCaregiverPhoto(parsed.caregiverPhoto || null);
                    setIsSecretAuthenticated(parsed.isSecretAuthenticated || false);
                    setShift(parsed.shift || "");
                    setRecords(parsed.records || {});
                }
            }, []);

            // --- GUARDAR DATOS ---
            React.useEffect(() => {
                const dataToSave = { caregiverData, caregiverPhoto, isSecretAuthenticated, shift, records };
                localStorage.setItem('careApp_data_v7', JSON.stringify(dataToSave));
            }, [caregiverData, caregiverPhoto, isSecretAuthenticated, shift, records]);

            const initiateCaregiverSelection = (e) => {
                const name = e.target.value;
                if (name) {
                    setTempCaregiverName(name);
                    setShowScanner(true); 
                } else {
                    setCaregiverData(null);
                    setCaregiverPhoto(null);
                    setIsSecretAuthenticated(false);
                }
            };

            const handleBiometricSuccess = (photoData, descriptor) => {
                // Almacenar temporalmente la foto y los datos para el 2¬∫ factor
                const selectedData = CAREGIVER_DATA.find(c => c.name === tempCaregiverName);
                if (selectedData) {
                    setCaregiverData(selectedData);
                }
                setCaregiverPhoto(photoData);    
                setShowScanner(false); // Cerrar esc√°ner para mostrar el 2¬∫ factor
            };

            const handleSecretSuccess = () => {
                setIsSecretAuthenticated(true); // El usuario ha pasado el 2¬∫ factor
            };

            const cancelScanner = () => {
                setShowScanner(false);
                setTempCaregiverName("");
            };
            
            const handleTaskCheck = (taskId) => {
                const now = new Date();
                const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true });
                setRecords(prev => {
                    const current = prev[taskId] || {};
                    if (current.checked) return { ...prev, [taskId]: { ...current, checked: false, time: null } };
                    return { ...prev, [taskId]: { ...current, checked: true, time: timeString } };
                });
            };

            const handleTaskNote = (taskId, text) => {
                setRecords(prev => ({ ...prev, [taskId]: { ...(prev[taskId] || {}), note: text } }));
            };

            const resetAll = () => {
                if(window.confirm("¬øCerrar sesi√≥n y finalizar turno?")) {
                    setCaregiverData(null); 
                    setCaregiverPhoto(null); 
                    setIsSecretAuthenticated(false);
                    setShift(""); 
                    setRecords({});
                    localStorage.removeItem('careApp_data_v7');
                }
            };

            const generateWhatsAppLink = () => {
                if (!caregiverData || !shift || !isSecretAuthenticated) { alert("Faltan datos de turno o autenticaci√≥n."); return; }

                // Obtener datos del paciente asignado
                const patient = PATIENTS.find(p => p.id === caregiverData.patientId);
                const taskList = patient.tasks[shift] || [];
                
                let message = `üîê *REPORTE MUVN SEGURO*\n`;
                message += `üìÖ *Fecha:* ${new Date().toLocaleDateString()}\n`;
                message += `üë§ *Cuidador:* ${caregiverData.name}\n`;
                message += `üõ°Ô∏è *Doble Factor:* Verificado\n`;
                message += `üåó *Turno:* ${shift.toUpperCase()}\n`;
                message += `üë¥ *Paciente:* ${patient.name} (${patient.details})\n\n`;
                message += `‚úÖ *TAREAS REALIZADAS:*\n`;
                
                let anyChecked = false;

                taskList.forEach(task => {
                    const rec = records[task.id];
                    if (rec && rec.checked) {
                        anyChecked = true;
                        message += `üîπ ${task.text} (${rec.time})\n`;
                        if (rec.note) message += `   üìù ${rec.note}\n`;
                    }
                });

                if (!anyChecked) {
                    message += "_(Ninguna tarea marcada como realizada en este reporte.)_\n";
                }
                
                const encodedMsg = encodeURIComponent(message);
                window.open(`https://wa.me/524451586270?text=${encodedMsg}`, '_blank');
            };

            const currentPatient = caregiverData ? PATIENTS.find(p => p.id === caregiverData.patientId) : null;
            const currentTasks = (currentPatient && shift) ? currentPatient.tasks[shift] : [];

            return (
                <div className="max-w-3xl mx-auto relative min-h-screen bg-slate-900">
                    {/* MODAL DEL ESC√ÅNER BIOM√âTRICO */}
                    {showScanner && (
                        <BiometricScanner 
                            userName={tempCaregiverName} 
                            onAuthSuccess={handleBiometricSuccess} 
                            onCancel={cancelScanner} 
                        />
                    )}

                    <header className="bg-slate-800 text-white p-4 shadow-lg sticky top-0 z-10 border-b border-cyan-900">
                        <div className="flex justify-between items-center">
                            <div>
                                <h1 className="text-xl font-bold flex items-center gap-2 text-cyan-400 font-mono tracking-tighter">
                                    <Icons.ShieldCheck /> MUVN <span className="text-[10px] bg-cyan-900 text-cyan-200 px-1 rounded">SECURE v7</span>
                                </h1>
                            </div>
                            <button onClick={resetAll} className="bg-red-600 hover:bg-red-700 text-white p-2 rounded flex items-center gap-1 text-xs">
                                <Icons.Trash2 /> Salir
                            </button>
                        </div>
                    </header>

                    <main className="p-4 space-y-6">
                        
                        {/* 1. SELECCI√ìN CUIDADOR / BIOMETR√çA */}
                        <section className="glass-panel p-4 rounded-xl shadow-lg border border-slate-700">
                            <label className="block text-sm font-bold text-cyan-100 mb-2 flex items-center gap-2">
                                <Icons.User /> Seleccionar Cuidador
                            </label>
                            
                            {!caregiverData ? (
                                <select onChange={initiateCaregiverSelection} value="" className="w-full p-3 bg-slate-800 border border-slate-600 rounded-lg text-lg text-white outline-none focus:border-cyan-500 transition-colors">
                                    <option value="">-- Iniciar Proceso de Acceso --</option>
                                    {CAREGIVER_DATA.map(c => <option key={c.name} value={c.name}>{c.name}</option>)}
                                </select>
                            ) : (
                                <div className="flex items-center gap-4 bg-cyan-900/30 border border-cyan-500/50 p-4 rounded-lg animate-fade-in">
                                    <div className="relative w-16 h-16 rounded-full overflow-hidden border-2 border-cyan-400 shadow-[0_0_15px_rgba(34,211,238,0.5)]">
                                        {caregiverPhoto ? 
                                            <img src={caregiverPhoto} className="w-full h-full object-cover" alt="Foto del Cuidador" />
                                            : <div className="w-full h-full bg-slate-700 flex items-center justify-center"><Icons.Camera /></div>
                                        }
                                    </div>
                                    <div>
                                        <p className="text-xs text-cyan-400 font-bold tracking-widest mb-1">CUIDADOR ENCONTRADO</p>
                                        <h2 className="text-xl font-bold text-white">{caregiverData.name}</h2>
                                    </div>
                                </div>
                            )}
                        </section>

                        {/* 2. AUTENTICACI√ìN SECRETA (DOBLE FACTOR) */}
                        {caregiverData && !isSecretAuthenticated && (
                            <SecretAuth
                                caregiverName={caregiverData.name}
                                requiredDob={caregiverData.dob}
                                requiredPet={caregiverData.pet}
                                onSuccess={handleSecretSuccess}
                            />
                        )}

                        {/* CONTENIDO PRINCIPAL (S√ìLO SI PAS√ì LOS 2 FACTORES) */}
                        {isSecretAuthenticated && caregiverData && (
                            <div className="space-y-6 animate-fade-in text-gray-200">
                                
                                {/* ASIGNACI√ìN PACIENTE √öNICO */}
                                <section className="glass-panel p-4 rounded-xl shadow-md border-2 border-green-500/50">
                                    <h2 className="text-lg font-bold text-green-400 flex items-center gap-2">
                                        <Icons.ShieldCheck /> Acceso Autorizado
                                    </h2>
                                    <p className="text-sm text-slate-300 mt-1">
                                        Solo puedes ver y registrar informaci√≥n para tu paciente asignado:
                                    </p>
                                    <div className="mt-3 bg-slate-800 p-3 rounded border border-slate-600">
                                        <div className="font-bold text-xl text-white">{currentPatient.name}</div>
                                        <div className="text-sm text-slate-400">{currentPatient.details}</div>
                                    </div>
                                </section>

                                {/* 3. SELECCI√ìN TURNO */}
                                <section className="grid grid-cols-2 gap-4">
                                    <button onClick={() => setShift('dia')} className={`p-4 rounded-xl border-2 flex flex-col items-center gap-2 transition-all ${shift === 'dia' ? 'border-amber-500 bg-amber-900/20 text-amber-400 shadow-[0_0_20px_rgba(245,158,11,0.2)]' : 'border-slate-700 bg-slate-800 text-slate-500 hover:border-slate-500'}`}>
                                        <Icons.Sun /><span className="font-bold">Turno D√≠a</span>
                                    </button>
                                    <button onClick={() => setShift('noche')} className={`p-4 rounded-xl border-2 flex flex-col items-center gap-2 transition-all ${shift === 'noche' ? 'border-indigo-500 bg-indigo-900/20 text-indigo-400 shadow-[0_0_20px_rgba(99,102,241,0.2)]' : 'border-slate-700 bg-slate-800 text-slate-500 hover:border-slate-500'}`}>
                                        <Icons.Moon /><span className="font-bold">Turno Noche</span>
                                    </button>
                                </section>

                                {/* 4. TAREAS */}
                                {shift && (
                                    <section className="space-y-3 pb-20">
                                        <h2 className="text-xl font-bold text-cyan-400 mb-4 flex items-center gap-2">
                                            <Icons.ClipboardList /> Tareas para el Turno {shift === 'dia' ? 'D√≠a' : 'Noche'}
                                        </h2>
                                        {currentTasks.map(task => {
                                            const rec = records[task.id] || {};
                                            const isChecked = rec.checked;
                                            return (
                                                <div key={task.id} className={`p-4 rounded-lg shadow transition-all border-l-4 ${isChecked ? 'bg-slate-800 border-l-slate-600 opacity-70' : 'bg-slate-800 border-l-cyan-500'}`}>
                                                    <div className="flex gap-3">
                                                        <button onClick={() => handleTaskCheck(task.id)} className={`w-8 h-8 rounded-full border-2 flex items-center justify-center transition-all ${isChecked ? 'bg-green-600 border-green-600 text-white' : 'border-slate-500 hover:border-cyan-400'}`}>
                                                            <Icons.CheckCircle className={isChecked ? 'opacity-100' : 'opacity-0'} />
                                                        </button>
                                                        <div className="flex-1">
                                                            <h3 className={`font-medium ${isChecked ? 'line-through text-slate-500' : 'text-gray-200'}`}>{task.text}</h3>
                                                            {task.details && <div className="text-xs text-amber-400 mt-1 flex items-center gap-1"><Icons.AlertCircle /> {task.details}</div>}
                                                            {isChecked && <span className="text-[10px] bg-green-900 text-green-300 px-2 py-0.5 rounded mt-2 inline-block font-mono">{rec.time}</span>}
                                                        </div>
                                                    </div>
                                                    <textarea 
                                                        placeholder="Notas del turno (ej: 'Glucosa en 120mg/dl', 'Sin incidentes')..." 
                                                        value={rec.note || ""} 
                                                        onChange={(e) => handleTaskNote(task.id, e.target.value)} 
                                                        className="w-full mt-3 p-2 text-sm bg-slate-900 border border-slate-700 rounded text-gray-300 focus:border-cyan-500 outline-none" 
                                                        rows={1} 
                                                    />
                                                </div>
                                            )
                                        })}
                                    </section>
                                )}
                            </div>
                        )}
                    </main>

                    {/* BOT√ìN DE REPORTE (S√ìLO CUANDO HAY TURNO, PACIENTE Y AUTENTICACI√ìN COMPLETA) */}
                    {isSecretAuthenticated && caregiverData && shift && (
                        <div className="fixed bottom-0 w-full bg-slate-900 border-t border-slate-700 p-4 z-20">
                            <div className="max-w-3xl mx-auto">
                                <button onClick={generateWhatsAppLink} className="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-emerald-900/50 flex flex-col items-center leading-tight transition-transform active:scale-95">
                                    <div className="flex items-center gap-2 text-lg">
                                        <Icons.Send /> Enviar Reporte de {currentPatient.name}
                                    </div>
                                    <span className="text-[10px] opacity-75">V√≠a WhatsApp - Identidad verificada</span>
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

